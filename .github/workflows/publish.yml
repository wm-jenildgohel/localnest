name: Publish to npm

on:
  push:
    branches:
      - main

concurrency:
  group: publish
  cancel-in-progress: false

jobs:
  # ─────────────────────────────────────────────
  # JOB 1 — validate version + check for duplicates
  # ─────────────────────────────────────────────
  validate:
    name: Validate version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.read.outputs.version }}
      tag: ${{ steps.read.outputs.tag }}
      already_published: ${{ steps.npm_check.outputs.already_published }}
    steps:
      - uses: actions/checkout@v4

      - name: Read version from package.json
        id: read
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Accept: X.Y.Z (stable) or X.Y.Z-beta.N (beta pre-release)
          if echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "Version $VERSION → tag: latest"
          elif echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+$'; then
            echo "tag=beta" >> $GITHUB_OUTPUT
            echo "Version $VERSION → tag: beta"
          else
            echo "::error::Version '$VERSION' does not match X.Y.Z or X.Y.Z-beta.N format."
            exit 1
          fi

      - name: Check if version already published on npm
        id: npm_check
        run: |
          VERSION="${{ steps.read.outputs.version }}"
          PACKAGE=$(node -p "require('./package.json').name")
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" "https://registry.npmjs.org/$PACKAGE/$VERSION")
          if [ "$HTTP" = "200" ]; then
            echo "already_published=true" >> $GITHUB_OUTPUT
            echo "::warning::$PACKAGE@$VERSION is already on npm — skipping publish."
          else
            echo "already_published=false" >> $GITHUB_OUTPUT
            echo "$PACKAGE@$VERSION is not yet published. Proceeding."
          fi

  # ─────────────────────────────────────────────
  # JOB 2 — syntax check + tests across Node matrix
  # ─────────────────────────────────────────────
  test:
    name: Test on Node ${{ matrix.node }}
    needs: validate
    if: needs.validate.outputs.already_published == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        node: ['18', '20', '22']
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Syntax check
        run: npm run check

      - name: Run tests
        run: npm test
        env:
          CI: true

  # ─────────────────────────────────────────────
  # JOB 3 — pack dry-run + required file check
  # ─────────────────────────────────────────────
  pack-check:
    name: Pack validation
    needs: validate
    if: needs.validate.outputs.already_published == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Dry-run pack and validate required files
        run: |
          PACK_OUTPUT=$(npm pack --dry-run 2>&1)
          echo "$PACK_OUTPUT"

          # Verify required files are included in the tarball
          for file in "bin/" "src/" "skills/" "README.md" "LICENSE" "CHANGELOG.md"; do
            if echo "$PACK_OUTPUT" | grep -q "$file"; then
              echo "✓ $file present"
            else
              echo "::error::Required file/dir missing from package: $file"
              exit 1
            fi
          done

      - name: Verify bin entries are executable
        run: |
          for bin in bin/localnest-mcp.js bin/localnest-mcp-setup.js bin/localnest-mcp-doctor.js bin/localnest-mcp-install-skill.js; do
            if [ ! -f "$bin" ]; then
              echo "::error::Missing bin file: $bin"
              exit 1
            fi
            echo "✓ $bin exists"
          done

  # ─────────────────────────────────────────────
  # JOB 4 — publish to npm
  # ─────────────────────────────────────────────
  publish:
    name: Publish ${{ needs.validate.outputs.version }} → ${{ needs.validate.outputs.tag }}
    needs: [validate, test, pack-check]
    if: needs.validate.outputs.already_published == 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Publish to npm
        run: npm publish --tag ${{ needs.validate.outputs.tag }} --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create git tag
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: v${{ needs.validate.outputs.version }}
          prerelease: ${{ needs.validate.outputs.tag == 'beta' }}
          generate_release_notes: true
